name: Deploy Backend with AWS CodeDeploy

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }} 
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2 

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2


      - name: Build and push Docker image to ECR
        uses: docker/build-push-action@v5
        with:
          context: ./server 
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/genz-bridge-backend:latest
          platforms: linux/amd64 

      - name: Trigger AWS CodeDeploy
        run: |
          APPSPEC_CONTENT=$(cat server/appspec.yml | tr -d '\n' | sed 's/"/\\"/g')

          aws deploy create-deployment \
            --application-name GenZBridgeBackend \
            --deployment-group-name GenZBridgeProdGroup \
            --deployment-config-name CodeDeployDefault.OneAtATime \
            --description "Automated deployment from GitHub Actions - ${{ github.sha }}" \
            --revision "revisionType=AppSpecContent,appSpecContent={content=$APPSPEC_CONTENT,sha256=$(shasum -a 256 server/appspec.yml | awk '{print $1}')}" \
            --file-exists-behavior OVERWRITE 